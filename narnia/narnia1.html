<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/over-the-wire/_next/static/css/86b7aba7af294b94.css" as="style"/><link rel="stylesheet" href="/over-the-wire/_next/static/css/86b7aba7af294b94.css" data-n-g=""/><link rel="preload" href="/over-the-wire/_next/static/css/22ea4df53befd5af.css" as="style"/><link rel="stylesheet" href="/over-the-wire/_next/static/css/22ea4df53befd5af.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/over-the-wire/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/over-the-wire/_next/static/chunks/webpack-f6318ba5529f7f5c.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/framework-81da43a8dcd978d9.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/main-00ca3f3974f0a67a.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/pages/_app-4def5050ef33c1d2.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/369-eeb2b79f75cc27b6.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/pages/narnia/narnia1-3707e6cd8c66db9a.js" defer=""></script><script src="/over-the-wire/_next/static/E6cBsGRJfur8BIPKmUXFH/_buildManifest.js" defer=""></script><script src="/over-the-wire/_next/static/E6cBsGRJfur8BIPKmUXFH/_ssgManifest.js" defer=""></script><script src="/over-the-wire/_next/static/E6cBsGRJfur8BIPKmUXFH/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><nav class="Nav_navBar__ioQlk"><ul class="Nav_navItems__n_3aD"><li class="Nav_navLink__4k_2G"><a href="/over-the-wire">Home</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/bandit">Bandit</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/natas">Natas</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/leviathan">Leviathan</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/narnia">Narnia</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/cipher">Cipher</a></li></ul></nav><div class="MainContainer_mainContainer__0FIFy"><div><h1>Narnia 1</h1><section><h2>Experience</h2><p>Starting this level, we again start by looking at the source code.</p><div class="CodeBlock_CodeBlock___IBBd"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-c" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#8be9fd">int<!-- --></span><span> <!-- --></span><span class="token" style="color:#f1fa8c">main<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">{<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#8be9fd">int<!-- --></span><span> <!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#f8f8f2">*<!-- --></span><span>ret<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span>
<!-- --><span></span><span class="token" style="color:#8be9fd">if<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#f1fa8c">getenv<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#50fa7b">&quot;EGG&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">==<!-- --></span><span class="token" style="color:#ff79c6">NULL<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">{<!-- --></span><span>
<!-- --></span><span>  <!-- --></span><span class="token" style="color:#f1fa8c">printf<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span>&quot;Give me something to execute at the env<!-- --></span><span class="token" style="color:#f8f8f2">-<!-- --></span><span>variable EGG
<!-- --></span><span>&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span>  <!-- --></span><span class="token" style="color:#f1fa8c">exit<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#bd93f9">1<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">}<!-- --></span><span>
<!-- --></span>
<!-- --><span></span><span class="token" style="color:#f1fa8c">printf<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span>&quot;Trying to execute EGG<!-- --></span><span class="token" style="color:#f8f8f2">!<!-- --></span><span>
<!-- --></span><span>&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span>ret <!-- --></span><span class="token" style="color:#f8f8f2">=<!-- --></span><span> <!-- --></span><span class="token" style="color:#f1fa8c">getenv<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#50fa7b">&quot;EGG&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f1fa8c">ret<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span>
<!-- --><span></span><span class="token" style="color:#8be9fd">return<!-- --></span><span> <!-- --></span><span class="token" style="color:#bd93f9">0<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">}<!-- --></span></code></pre></div><p>We may observe several interesting thing, first a declaration of a pointer called <!-- --><code>ret</code> which points to a function. There is also a usage of <!-- --><code>getenv</code> which gets an environment variable, which here seems to be called <!-- --><em>EGG</em>. It then sets the function pointer to whatever is inside the EGG environment varialbe and then executes it. So, clearly, we must insert some type of program into the EGG environment variable to obtain the password for Narnia 2.<!-- --></p><p>I could understand so far that we must set the environment variable to something executable, however, I did not know how to proceed. Searching setting environment variable vulnerabilities led to a <!-- --><a href="https://owasp.org/www-community/attacks/Buffer_Overflow_via_Environment_Variables">page in owasp.org</a>. This seem tangentially related, however, it uses environment variable to create a buffer overflow rather than creating an executable function. Lastly, I was forced to find hints regarding this level. I learnt that we were supposed to use something called shellcode.<!-- --></p><p>As the creation of shellcodes could be quite difficult especially in relation to removing null bytes, we can use a ready shellcode taken from websites such as <!-- --><a href="http://shell-storm.org/shellcode/">exploit-db</a>. If we analyse the code of narnia0, it calls <!-- --><code>execve</code> with <!-- --><code>/bin/sh</code> as arguments, so searching for a shellcode that does those, I found one from <!-- --><a href="https://www.exploit-db.com/exploits/39160">exploit-db</a>. It took several tries to find a working shellcode. We must then write this hex code to an environment variable without it being considered as merely a string, so we use the <!-- --><code>printf</code> shell function. Export the environment variable like so:<!-- --></p><div class="CodeBlock_CodeBlock___IBBd"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-shell" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token" style="color:#f1fa8c">export<!-- --></span><span> <!-- --></span><span class="token assign-left" style="color:#f8f8f2">EGG<!-- --></span><span class="token" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">$(<!-- --></span><span class="token" style="color:#f1fa8c">printf<!-- --></span><span class="token" style="color:#f8f8f2"> <!-- --></span><span class="token" style="color:#50fa7b">&quot;<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x6a<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x0b<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x58<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x31<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\xf6<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x56<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x68<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x2f<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x2f<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x73<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x68<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x68<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x2f<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x62<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x69<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x6e<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x89<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\xe3<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x31<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\xc9<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x89<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\xca<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\xcd<!-- --></span><span class="token" style="color:#f8f8f2;cursor:help">\x80<!-- --></span><span class="token" style="color:#50fa7b">&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span></code></pre></div><p>This will run the shell just like in Narnia 0, and we would just use <!-- --><code>cat</code> to obtain the password for Narnia2.<!-- --></p></section><section><h2>Research</h2><p>What is shellcode? Shellcode is just a general term for an injected payload that will be executed by a target program. The term shellcode does not mean it is related to shell commands. The term came from its background as a payload to create a shell for the attacker to utilise. In relation to the shellcode shown, each hex number represents an assembly operation. A good understanding could be earned if we consider a small C code. For example, a small program printing hello world.</p><div class="CodeBlock_CodeBlock___IBBd"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-c" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token macro directive-hash" style="color:#ff79c6">#<!-- --></span><span class="token macro directive" style="color:#8be9fd">include<!-- --></span><span class="token macro" style="color:#ff79c6"> <!-- --></span><span class="token macro" style="color:#50fa7b">&lt;stdio.h&gt;<!-- --></span><span>
<!-- --></span>
<!-- --><span></span><span class="token" style="color:#8be9fd">int<!-- --></span><span> <!-- --></span><span class="token" style="color:#f1fa8c">main<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#8be9fd">void<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span> <!-- --></span><span class="token" style="color:#f8f8f2">{<!-- --></span><span>
<!-- --></span><span>  <!-- --></span><span class="token" style="color:#f1fa8c">printf<!-- --></span><span class="token" style="color:#f8f8f2">(<!-- --></span><span class="token" style="color:#50fa7b">&quot;Hello world&quot;<!-- --></span><span class="token" style="color:#f8f8f2">)<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span>  <!-- --></span><span class="token" style="color:#8be9fd">return<!-- --></span><span> <!-- --></span><span class="token" style="color:#bd93f9">0<!-- --></span><span class="token" style="color:#f8f8f2">;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">}<!-- --></span></code></pre></div><p>When this is compiled, we can see the hex representation of all the assembly instructions using <!-- --><code>objdump</code>. It is located at the centre, as seen in the picture below.<!-- --></p><div class="BlogImage_imgContainer__s2tL6"><img src="/over-the-wire/images/narnia1-1.png" alt="the hex representation of assembly instruction located at the centre of the objdump result" width="600"/></div><p>These are the operation codes to run the program of printing hello world. The main problem with this is that, the usage of null bytes in a string could terminate the string, this is undesirable product.Therefore, normally, these opcode shellcodes are written directly using assembly or at least edited to avoid operations with null bytes. It is also possible to find shellcodes already made by others, namely, in the website <!-- --><a href="http://shell-storm.org/shellcode/"> shell-storm</a>. To read more about shellcode, I would recommend reading about them in this, <!-- --><a href="https://www.exploit-db.com/docs/english/13019-shell-code-for-beginners.pdf">document written by exploit-db.com</a></p><p>Another thing to consider was that since these shellcodes utilises hex representation of operation codes, it is limited to the specific infrastructure that uses the same operation codes.</p></section><section><h2>Reflection</h2><p>This was quite a difficult CTF level, but I&#x27;ve learnt a few things that I had not known before. Namely that we may insert what seems to be just a string of hex, when instead it is an fully executable program. That was quite interesting to see. When doing buffer overflow attack, it at first seem limited to what we can do. However, seeing how it is possible to write assembly instructions, it reveals to me what a buffer overflow attack can fully accomplish. This made me reconsider how I should perceive potential overflow problems.</p><p>In terms of completing the challenge, I did feel that I may have taken too long in trying to figure out what I should insert in the environment variable. While I still feel that requiring hints was a little dissapointing, at the end I was able to find my own shellcode and assign it to the environment variable with my own understanding of what I&#x27;m trying to accomplish and how everything should work.</p></section><section><h2>Key</h2><div class="SpoilerKey_codeBlock__KWl0d"><div class="SpoilerKey_spoilerToggler__HCeWZ"><button>Click to Reveal</button></div><div class="SpoilerKey_spoilerContainer__O76It"><div class="SpoilerKey_spoiler__YWx_s "><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>nairiepecu<!-- --></span></code></pre></div></div></div></section><div class="PageNav_pageNav__NXqbT"><div><a title="Previous page" class="PageNav_navButton__yHhmO" href="/over-the-wire/narnia/narnia0">◀</a></div><div><a title="Next page" class="PageNav_navButton__yHhmO" href="/over-the-wire/narnia/narnia2">▶</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/narnia/narnia1","query":{},"buildId":"E6cBsGRJfur8BIPKmUXFH","assetPrefix":"/over-the-wire","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>