<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="/over-the-wire/_next/static/css/86b7aba7af294b94.css" as="style"/><link rel="stylesheet" href="/over-the-wire/_next/static/css/86b7aba7af294b94.css" data-n-g=""/><link rel="preload" href="/over-the-wire/_next/static/css/2a97f9c7fde1f37f.css" as="style"/><link rel="stylesheet" href="/over-the-wire/_next/static/css/2a97f9c7fde1f37f.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/over-the-wire/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/over-the-wire/_next/static/chunks/webpack-f6318ba5529f7f5c.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/framework-81da43a8dcd978d9.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/main-00ca3f3974f0a67a.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/pages/_app-4def5050ef33c1d2.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/369-eeb2b79f75cc27b6.js" defer=""></script><script src="/over-the-wire/_next/static/chunks/pages/natas/natas12-1a5738910bfee032.js" defer=""></script><script src="/over-the-wire/_next/static/STFoTY5ZHPeRm1YrlssPY/_buildManifest.js" defer=""></script><script src="/over-the-wire/_next/static/STFoTY5ZHPeRm1YrlssPY/_ssgManifest.js" defer=""></script><script src="/over-the-wire/_next/static/STFoTY5ZHPeRm1YrlssPY/_middlewareManifest.js" defer=""></script></head><body><div id="__next"><nav class="Nav_navBar__ioQlk"><ul class="Nav_navItems__n_3aD"><li class="Nav_navLink__4k_2G"><a href="/over-the-wire">Home</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/bandit">Bandit</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/natas">Natas</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/leviathan">Leviathan</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/narnia">Narnia</a></li><li class="Nav_navLink__4k_2G"><a href="/over-the-wire/cipher">Cipher</a></li></ul></nav><div class="MainContainer_mainContainer__0FIFy"><div><h1>Natas 12</h1><div class="Keyword_keyword__javqt"><p class="Keyword_keywordHead__40fuD">Keywords: </p><span class="Tag_tag__AJnTY">file-upload</span></div><section><h2>Experience</h2><p>For my first impression, nothing really seem out of the ordinary in the source file. No execution of shell commands, no obvious variable storing the password, it seems to do what it is supposed to do. So, considering that the level asks to upload a file, it must then be the uploading of a file that is the vulnerability. The question is, what could we upload to obtain the password?</p><div class="BlogImage_imgContainer__s2tL6"><img src="/over-the-wire/images/natas12-1.png" alt="The challenge page consists of a prompt asking for choosing a jpeg file to upload and the upload button" width="600"/></div><p>The tutorial by <!-- --><a href="https://www.hacksplaining.com/exercises/file-upload#/start">hacksplaining</a> showed in general the process of uploading malicious code, essentially, if the file upload is unrestricted, we will be able to run the code by simply going to the url to that file.<!-- --></p><div class="CodeBlock_CodeBlock___IBBd"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-php" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token php language-php delimiter" style="color:#ffb86c;font-weight:bold">&lt;?<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#8be9fd">function<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php function-definition" style="color:#f1fa8c">makeRandomPath<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$dir<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$ext<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#8be9fd">do<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$path<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">=<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$dir<!-- --></span><span class="token php language-php" style="color:#f8f8f2">.<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;/&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">.<!-- --></span><span class="token php language-php" style="color:#f1fa8c">genRandomString<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">.<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;.&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">.<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$ext<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#8be9fd">while<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f1fa8c">file_exists<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$path<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#8be9fd">return<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$path<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#8be9fd">function<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php function-definition" style="color:#f1fa8c">makeRandomPathFromFilename<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$dir<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$fn<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$ext<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">=<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">pathinfo<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$fn<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#ff79c6">PATHINFO_EXTENSION<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#8be9fd">return<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">makeRandomPath<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$dir<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$ext<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#8be9fd">if<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f1fa8c">array_key_exists<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;filename&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php global">$_POST<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$target_path<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">=<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">makeRandomPathFromFilename<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;upload&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php global">$_POST<!-- --></span><span class="token php language-php" style="color:#f8f8f2">[<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;filename&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">]<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">        <!-- --></span><span class="token php language-php" style="color:#8be9fd">if<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f1fa8c">filesize<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php global">$_FILES<!-- --></span><span class="token php language-php" style="color:#f8f8f2">[<!-- --></span><span class="token php language-php single-quoted-string" style="color:#50fa7b">&#x27;uploadedfile&#x27;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">]<!-- --></span><span class="token php language-php" style="color:#f8f8f2">[<!-- --></span><span class="token php language-php single-quoted-string" style="color:#50fa7b">&#x27;tmp_name&#x27;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">]<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">&gt;<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#bd93f9">1000<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">        <!-- --></span><span class="token php language-php" style="color:#8be9fd">echo<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;File is too big&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#8be9fd">else<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">        <!-- --></span><span class="token php language-php" style="color:#8be9fd">if<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php" style="color:#f1fa8c">move_uploaded_file<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php global">$_FILES<!-- --></span><span class="token php language-php" style="color:#f8f8f2">[<!-- --></span><span class="token php language-php single-quoted-string" style="color:#50fa7b">&#x27;uploadedfile&#x27;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">]<!-- --></span><span class="token php language-php" style="color:#f8f8f2">[<!-- --></span><span class="token php language-php single-quoted-string" style="color:#50fa7b">&#x27;tmp_name&#x27;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">]<!-- --></span><span class="token php language-php" style="color:#f8f8f2">,<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">$target_path<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">            <!-- --></span><span class="token php language-php" style="color:#8be9fd">echo<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;The file &lt;a href=&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">$target_path<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;&gt;<!-- --></span><span class="token php language-php double-quoted-string interpolation" style="color:#50fa7b">$target_path<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&lt;/a&gt; has been uploaded&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">        <!-- --></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#8be9fd">else<!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">            <!-- --></span><span class="token php language-php" style="color:#8be9fd">echo<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;There was an error uploading the file, please try again!&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">        <!-- --></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php">    <!-- --></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php" style="color:#f8f8f2">}<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#8be9fd">else<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f8f8f2">{<!-- --></span><span class="token php language-php">
<!-- --></span><span class="token php language-php"></span><span class="token php language-php delimiter" style="color:#ffb86c;font-weight:bold">?&gt;<!-- --></span><span>
<!-- --></span>
<!-- --><span></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">form<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">enctype<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">multipart/form-data<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">action<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">index.php<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">method<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">POST<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f8f8f2">&gt;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">input<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">type<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">hidden<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">name<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">MAX_FILE_SIZE<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">value<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">1000<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">input<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">type<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">hidden<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">name<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">filename<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">value<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token php language-php delimiter" style="color:#f1fa8c">&lt;?<!-- --></span><span class="token php language-php" style="color:#f1fa8c"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">print<!-- --></span><span class="token php language-php" style="color:#f1fa8c"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">genRandomString<!-- --></span><span class="token php language-php" style="color:#f1fa8c">(<!-- --></span><span class="token php language-php" style="color:#f1fa8c">)<!-- --></span><span class="token php language-php" style="color:#f1fa8c">;<!-- --></span><span class="token php language-php" style="color:#f1fa8c"> <!-- --></span><span class="token php language-php delimiter" style="color:#f1fa8c">?&gt;<!-- --></span><span class="token" style="color:#f1fa8c">.jpg<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span><span>
<!-- --></span><span>Choose a JPEG to upload (max 1KB):<!-- --></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">br<!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">input<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">name<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">uploadedfile<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">type<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">file<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">br<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span><span>
<!-- --></span><span></span><span class="token" style="color:#f8f8f2">&lt;<!-- --></span><span class="token" style="color:#ff79c6">input<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">type<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">submit<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#50fa7b">value<!-- --></span><span class="token attr-equals" style="color:#f8f8f2">=<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#f1fa8c">Upload File<!-- --></span><span class="token" style="color:#f8f8f2">&quot;<!-- --></span><span class="token" style="color:#ff79c6"> <!-- --></span><span class="token" style="color:#f8f8f2">/&gt;<!-- --></span></code></pre></div><p>The above snippet of code highlights the main parts important for us. We note that there is a hidden input component named <!-- --><em>filename</em>that will get a random string followed by a jpg extension which will be then used by the server as the name of the uploaded file. To execute the file we upload, we must ensure that it keeps the original extension. But firstly what should the uploaded malicious code do? We simply need to obtain the password inside <!-- --><code>/etc/natas_webpass/natas13</code>, so what we need is to use a shell command, specifically <!-- --><code>cat</code>.<!-- --></p><div class="CodeBlock_CodeBlock___IBBd"><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:.5em 0;overflow:auto;border-radius:0.3em"><code class="language-php" style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span class="token php language-php delimiter" style="color:#ffb86c;font-weight:bold">&lt;?php<!-- --></span><span class="token php language-php"> <!-- --></span><span class="token php language-php" style="color:#f1fa8c">system<!-- --></span><span class="token php language-php" style="color:#f8f8f2">(<!-- --></span><span class="token php language-php double-quoted-string" style="color:#50fa7b">&quot;cat /etc/natas_webpass/natas13&quot;<!-- --></span><span class="token php language-php" style="color:#f8f8f2">)<!-- --></span><span class="token php language-php" style="color:#f8f8f2">;<!-- --></span><span class="token php language-php delimiter" style="color:#ffb86c;font-weight:bold">?&gt;<!-- --></span></code></pre></div><p>We then upload that file. Now, to go around the file extension was actually surprisingly simple, the &quot;hidden&quot; filename value is available to us through the developer tool. Therefore, we could simply change the value.</p><div class="BlogImage_imgContainer__s2tL6"><img src="/over-the-wire/images/natas12-2.png" alt="page source code after the filename extension was changed to .php" width="600"/></div><p>Now notice from the source code of the page that when filename exist, it will call the <!-- --><code>makeRandomPathFromFilename</code> function. This will change the name of the file from the value of filename, however it keeps the extension of that value. The only other thing preventing an invalid image is the filesize. With a single line php code, this shouldn&#x27;t be a problem. Now with everything done, we then upload the file.<!-- --></p><div class="BlogImage_imgContainer__s2tL6"><img src="/over-the-wire/images/natas12-3.png" alt="resulting page when the file is uploaded" width="600"/></div><p>As we see, the php file is kept, and we simply append that path to the url or in this case, we can simply click on the link they have conveniently given us. Like that we will get the password for natas13.</p></section><section><h2>Research</h2><p>Owasp has a good <!-- --><a href="https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload">entry regarding unrestricted file upload</a>. A potential risk, I didn&#x27;t think about was overwriting critical files using relative paths, potentially changing files such as index.php itself, this would allow the attacker to modify the website for everyone else, creating a phising page. File uploads is a common method of Cross Site Scripting attacks that effect every user who subsequently visit the website. But in general, with high enough authorisation, it could run arbitrary shell command with limitless possibility, e.g. exploring the file directory of the server, execute a malware, obtain user data, etc.<!-- --></p><p>The same Owasp webpage also lists several potential file upload vulnerability practices. An example was to check the file extension, this could be vulnerable to perhaps double extensions. Or, there could be a flaw in the function replacing the dangerous extension. Or, an attacker could use neutral characters after a filename, so that it doesn&#x27;t end in the forbidden extension.</p><p>There are several potential solutions that could be use to make file uploading functionality more secure and are better used in combination. One prevention method could be to not allow users direct access to the filename and extension of the file when it will be saved on the server, so in this scenario, it should have changed the extension during the uploading process, rather than using a hidden form input element. Limiting the filename was also listed as this would make it more difficult to fool name checking functions. Removing control characters in filename, including its unicode representation. Restrict permission on the directory that stores the uploaded files.</p></section><section><h2>Reflection</h2><p>This was a really fun challenge and a good introduction to how file uploads could be used by attackers. Uploading files could be dangerous as it will store user input inside the server which may be executable. This could then be used in file inclusion attacks we have seen previously, XSS, or we could simply run any commands we would like. There isn&#x27;t really a limit once we are able to execute arbitrary commands on a computer.</p><p>Therefore, this level really reminded me to be careful when not only taking user inputs in form of text but also in form of files themselves. This functionality is often used in many websites, for example for the purpose of adding a profile picture, but in turns out that something this simple and widely done also have a very huge potential for being exploited. I guess it&#x27;s a reminder to be ever vigilant about the code we write.</p><p></p></section><section><h2>Key</h2><div class="SpoilerKey_codeBlock__KWl0d"><div class="SpoilerKey_spoilerToggler__HCeWZ"><button>Click to Reveal</button></div><div class="SpoilerKey_spoilerContainer__O76It"><div class="SpoilerKey_spoiler__YWx_s "><pre style="color:#f8f8f2;background:#282a36;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none;padding:1em;margin:0;overflow:auto;border-radius:0.3em"><code style="color:#f8f8f2;background:none;text-shadow:0 1px rgba(0, 0, 0, 0.3);font-family:Consolas, Monaco, &#x27;Andale Mono&#x27;, &#x27;Ubuntu Mono&#x27;, monospace;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none"><span>jmLTY0qiPZBbaKc9341cqPQZBJv7MQbY<!-- --></span></code></pre></div></div></div></section><div class="PageNav_pageNav__NXqbT"><div><a title="Previous page" class="PageNav_navButton__yHhmO" href="natas11">◀</a></div><div><a title="Next page" class="PageNav_navButton__yHhmO" href="natas13">▶</a></div></div></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{}},"page":"/natas/natas12","query":{},"buildId":"STFoTY5ZHPeRm1YrlssPY","assetPrefix":"/over-the-wire","nextExport":true,"autoExport":true,"isFallback":false,"scriptLoader":[]}</script></body></html>